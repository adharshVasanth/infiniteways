<html>
  <head>
    <title>
      Notion API integration example
    </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/json-formatter-js@2.3.4/dist/json-formatter.min.css">
    <style>
      body {
        padding: 10px;
      }
      .notion-hq-output{
        background-color: #f2f2f2;
        padding: 20px;
        border: 1px #e2e3e5 solid;
        border-radius: 5px;
        margin: 10px 0px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      .notion-hq-output-formatted{
        background-color: #161616;
        display: block;
        padding: 10px;
        white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        white-space: pre-wrap; /* css-3 */
      }
      #notion-hq-input {
        height: 300px;
        background-color: #e6e6e6;
        margin-bottom: 10px;
      }
      .databases-query-entry {
        width: 250px;
        margin:5px;
        border: 1px #e2e3e5 solid;
        background-color: #f7f7f7;
        border-radius: 5px;
      }
      .database-query-entry--image-container {
        width: auto;
        height: 250px;
      }
      .database-query-entry--image {
        object-fit: cover;
        width: 100%;
        height: 100%;
      }
      .databases-query-entry--author-avatar {
        display: inline-block;
        border-radius: 50%;
        height:30px;
      }
    </style>
  </head>
  <body>
    <h1>
      Notion API integration example
    </h1>
    <p>
      This example uses packages: Wrangler from cloudflare to create a local worker server that also integrates @notionhq/client&nbsp;
      that fetch data from notion api and integration. This is basically a form that collects data from clientside and send it to a worker located on a cloudflare server.&nbsp;
      This server acts a proxy to collect information from the notion Apiand sends back tha data to client. Client process this data and display it.&nbsp;
      The wrangler plugin helps to do the work of the worker on a local server. Nevertheless it should be deployed to the worker.&nbsp;
    </p>
    <h2>
      Further improvements
    </h2>
    <p>
      <ul>
        <li>A form that can be used to make the json string/ query</li>
        <li>Grid and table dislay</li>
        <li>Pagination which is stable</li>
        <li>A unified interface for data collection</li>
        <li>Page fetch, Page details fetch</li>
        <li>Table fiter and sort</li>
        <li>Search widget, suggestions</li>
        <li>Loading spinners and placeholders</li>
        <li>Error management</li>
        <li>unlikely: Users fetch, logins, web editor and publisher</li>
        <li>Compacting code, testing and compatibility</li>
      </ul>
    </p>
    <h2>Input</h2>
    <p> 
      <form class="notion-hq-input-form" onSubmit="return false">
        <div class="form-floating">
          <textarea id="notion-hq-input" class="form-control notion-hq-input" placeholder="input">
{
  "function": "databasesQuery",
  "data": {
    "databaseId": "4153efddccc84e3a80012ac7d36bbb2a",
    "entryCategory": "all",
    "entryArchivedInclude": true,
    "entryMaxNumber": 5,
    "entryDisplay": "grid",
    "pagination": {
      "enable": true
    }
  },
  "output": {
    "element": ".notion-hq-output",
    "console": {
      "enable": true,
      "element": ".notion-hq-output-formatted"
    }
  }
}
          </textarea>
          <label for="notion-hq-input">notion-hq-input</label>
        </div>
        <button class="notion-hq-trigger-btn btn btn-primary" type="button" type="submit">Go</button>
      </form>
    </p>
    <h2>Output</h2>
    <p>
      <div class="notion-hq-output"></div>
      output from server: <br/>
      <pre><code class="notion-hq-output-formatted"></code></pre>
    </p>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/json-formatter-js@2.3.4/dist/json-formatter.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script>
    $(document).ready(function() {
      window.requestInput = $('.notion-hq-input').val()
      notionHqQuery(window.requestInput)
    })
    $('.notion-hq-trigger-btn').on('click', function() {
      window.requestInput = $('.notion-hq-input').val()
      notionHqQuery(window.requestInput)
    })
    function notionHqQuery(requestInput) {
      var ajaxFunction =  $.ajax(
        {
          type: 'POST',
          method: 'POST',
          url: /*'http://127.0.0.1:8787'*/'https://data.infiniteways.workers.dev',
          dataType:'json',
          //data is sent as json to the server, but it reach there as form data
          contentType:'application/x-www-form-urlencoded; charset=UTF-8',
          //default data sending and recieving MIME typealthough data is sent as json from the worker
          data: requestInput,
          /*data sent from the input as a json string no need for stringify it*/
          beforeSend: function() {
            var requestInput = JSON.parse(window.requestInput)
            console.log(`notionHqQuery(${requestInput})`)
            $(requestInput.output.element).html('empty')
            $(requestInput.output.console.element).html('empty')
          },
          success: function(xhr, status, result/*result is recieved as object but sent as json from worker*/) {
            var _function = xhr.responseOutput.function
            if(_function == 'databasesQuery') {
              var _data = xhr.responseOutput.data.responseData
              var length = _data.length
              var _outputData = `
              <h3>found ${length} results in "${xhr.responseOutput.data.entryCategory}"</h3>
              `
              if(!xhr.responseOutput.data.entryArchivedInclude) {
                _outputData += `excluding archived<br/><br/>`
              }
              for(let i = 0; i < length; i++) {//create entries loop
                if(xhr.responseOutput.data.entryDisplay == 'grid') {
                  _outputData += `
                    <div class="databases-query-entry d-inline-block">
                      <div class="database-query-entry--header p-3 h6">
                        ${_data[i].properties.Category.select.name}
                      </div>
                      <div class="database-query-entry--image-container">
                        <img class="database-query-entry--image" src="${_data[i].cover.file.url}"></img>
                      </div>
                      <div class="databases-query-entry--title h4 p-3">
                        ${_data[i].icon.emoji}&nbsp;${_data[i].properties.Name.title[0].plain_text}
                      </div>
                      <div class="databases-query-entry--id font-monospace p-3 d-none">
                        ${_data[i].id}
                      </div>
                      <div class="databases-query-entry--created-time p-3">
                        Created on: ${_data[i].created_time}
                      </div>
                      <div class="databases-query-entry--author-continer p-3">
                        <img class="databases-query-entry--author-avatar" src="${_data[i].properties.Author.people[0].avatar_url}"></img>&nbsp;
                        <span class="databases-query-entry--author-name">${_data[i].properties.Author.people[0].name}</span>
                      </div>
                      <div class="databases-query-entry--link p-3">
                        <a href="${_data[i].public_url}" target=new">Link</a>
                      </div>
                    </div>
                  `
                }else {
                  _outputData += `
                  table
                  `
                }
              }
            }
            $(xhr.responseOutput.output.element).html(_outputData)
            if(xhr.responseOutput.output.console.enable) {//enable console and diagnostics
              //console.log([{xhr}, {status}, {result}])
              var formatterConfig = {
                hoverPreviewEnabled: false,
                hoverPreviewArrayCount: 100,
                hoverPreviewFieldCount: 5,
                theme: 'dark',
                animateOpen: true,
                animateClose: true,
                useToJSON: true
              }
              result.responseText = "truncated"
              const formatter = new JSONFormatter([{xhr}, {status}, {result}],3,formatterConfig);
              $(xhr.responseOutput.output.console.element).html(formatter.render())
            }else{
              $(xhr.responseOutput.output.console.element).html('')
            }
          },
          error: function(xhr, status, error) {
            console.log([{xhr}, {status}, {error}])
            console.log('notionHqQuery() error')
          },
          complete: function() {
            console.log('notionHqQuery() complete')
          },
        }
      )
      return ajaxFunction
    }
  </script>
</html>
